<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OIG Cloud Dashboard</title>
    <script src="/oig_cloud_static/chart-loader.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            /* OPRAVA: Pou≈æ√≠t HA CSS promƒõnn√© pro t√©mata */
            background-color: var(--primary-background-color, #fafafa);
            color: var(--primary-text-color, #212121);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* NOV√â: Automatick√° detekce tmav√©ho re≈æimu */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--primary-background-color, #111111);
                color: var(--primary-text-color, #e1e1e1);
            }
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card-background-color, white);
            border-radius: var(--ha-card-border-radius, 8px);
            padding: 20px;
            box-shadow: var(--ha-card-box-shadow, 0 2px 8px rgba(0,0,0,0.1));
            border: 1px solid var(--divider-color, #e0e0e0);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-text-color, #212121);
        }

        .chart-container {
            width: 100%;
            height: 400px;
            background: var(--card-background-color, white);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-text-color, #666);
        }

        .error {
            color: var(--error-color, #f44336);
            text-align: center;
            padding: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .status-online { background-color: var(--success-color, #4caf50); }
        .status-offline { background-color: var(--error-color, #f44336); }
        .status-loading {
            background-color: var(--warning-color, #ff9800);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* NOV√â: Tlaƒç√≠tko pro p≈ôep√≠n√°n√≠ t√©matu */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color, #03a9f4);
            color: var(--text-primary-color, white);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 18px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--primary-color-dark, #0288d1);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- NOV√â: Tlaƒç√≠tko pro p≈ôep√≠n√°n√≠ t√©matu -->
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="P≈ôepnout t√©ma">
        üåô
    </button>

    <div class="dashboard-container">
        <!-- Connection Status -->
        <div class="card">
            <div class="card-title">
                üåê Stav p≈ôipojen√≠
                <span id="connection-status" class="status-indicator status-loading"></span>
            </div>
            <div id="connection-info" class="loading">P≈ôipojov√°n√≠...</div>
        </div>

        <!-- Battery Forecast Card -->
        <div class="card">
            <div class="card-title">üîã Predikce kapacity baterie</div>
            <div id="battery-chart" class="chart-container loading">Naƒç√≠t√°n√≠ grafu...</div>
        </div>

        <!-- Solar Forecast Card -->
        <div class="card">
            <div class="card-title">‚òÄÔ∏è P≈ôedpovƒõƒè sol√°rn√≠ v√Ωroby</div>
            <div id="solar-chart" class="chart-container loading">Naƒç√≠t√°n√≠ grafu...</div>
        </div>

        <!-- Spot Prices Card -->
        <div class="card">
            <div class="card-title">üí∞ Spotov√© ceny elekt≈ôiny</div>
            <div id="prices-chart" class="chart-container loading">Naƒç√≠t√°n√≠ grafu...</div>
        </div>
    </div>

    <script>
        // OPRAVA: Naƒç√≠st HA bridge p≈ôed dashboard inicializac√≠
        const scriptElement = document.createElement('script');
        scriptElement.src = '/oig_cloud_static/ha-bridge.js';
        document.head.appendChild(scriptElement);

        // Inicializace dashboard po naƒçten√≠ Apex Charts
        window.OIG_CHART_CONFIG.autoLoad = true;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Indik√°tor naƒç√≠t√°n√≠
                document.getElementById('connection-status').className = 'status-indicator status-loading';
                document.getElementById('connection-info').textContent = 'Naƒç√≠t√°n√≠ Apex Charts...';

                // OPRAVA: Kontrola dostupnosti chart loaderu
                if (!window.ApexChartsLoader) {
                    throw new Error('Chart loader nen√≠ dostupn√Ω');
                }

                // Naƒçten√≠ chart knihovny
                await window.ApexChartsLoader.load();

                // OPRAVA: Kontrola dostupnosti dashboard t≈ô√≠dy
                if (typeof OigCloudDashboard === 'undefined') {
                    throw new Error('Dashboard t≈ô√≠da nen√≠ dostupn√° - zkontrolujte dashboard.js');
                }

                // Inicializace dashboard
                const dashboard = new OigCloudDashboard();
                await dashboard.init();

                // √öspƒõ≈°n√© p≈ôipojen√≠
                document.getElementById('connection-status').className = 'status-indicator status-online';
                document.getElementById('connection-info').innerHTML = `
                    <strong>P≈ôipojeno</strong><br>
                    Apex Charts verze: ${window.ApexChartsLoader.getVersion()}<br>
                    <small>Pou≈æ√≠v√° re√°ln√° data ze senzor≈Ø</small>
                `;

            } catch (error) {
                console.error('Dashboard initialization failed:', error);
                document.getElementById('connection-status').className = 'status-indicator status-offline';
                document.getElementById('connection-info').innerHTML = `
                    <strong>Chyba p≈ôipojen√≠</strong><br>
                    ${error.message}<br>
                    <button onclick="location.reload()" style="margin-top: 10px;">Zkusit znovu</button>
                `;
            }
        });

        // NOV√â: Funkce pro detekci a nastaven√≠ t√©matu
        function detectTheme() {
            // Zkusit ƒç√≠st z Home Assistant
            if (window.parent && window.parent.document) {
                const haTheme = window.parent.document.querySelector('html').getAttribute('data-theme');
                if (haTheme) {
                    return haTheme.includes('dark') ? 'dark' : 'light';
                }
            }

            // Fallback na system preference
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);

            // Aktualizovat ikonu tlaƒç√≠tka
            const toggleButton = document.getElementById('theme-toggle');
            if (toggleButton) {
                toggleButton.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            // Ulo≈æit preference
            localStorage.setItem('oig-dashboard-theme', theme);

            // Aktualizovat grafy pokud existuj√≠
            if (window.oigDashboard) {
                window.oigDashboard.updateChartThemes(theme);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        // Inicializovat t√©ma p≈ôi naƒçten√≠
        document.addEventListener('DOMContentLoaded', () => {
            // Zkusit naƒç√≠st ulo≈æenou preference
            let savedTheme = localStorage.getItem('oig-dashboard-theme');

            // Pokud nen√≠ ulo≈æen√°, detekovat z HA nebo syst√©mu
            if (!savedTheme) {
                savedTheme = detectTheme();
            }

            applyTheme(savedTheme);

            // Poslouchat zmƒõny syst√©mov√©ho t√©matu
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('oig-dashboard-theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        });
    </script>
    <script src="/oig_cloud_static/dashboard.js"></script>
</body>
</html>
